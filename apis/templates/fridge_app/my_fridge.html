<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ person.name }}ë‹˜ì˜ ëƒ‰ì¥ê³ </title>
    <style>
        body { font-family: sans-serif; margin: 30px; }
        h1 { color: #2d6cdf; }
        table { width: 60%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f4f4f4; }
        .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; }
        .add-btn { background: #4CAF50; color: white; }
        .del-btn { background: #e53935; color: white; }
        .like-btn { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ¥¬ {{ person.name }}ë‹˜ì˜ ëƒ‰ì¥ê³ </h1>

    <h2>ëƒ‰ì¥ê³  ì¬ë£Œ</h2>
    <table>
        <tr>
            <th>ì¬ë£Œ</th><th>ìˆ˜ëŸ‰</th><th>ìœ í†µê¸°í•œ</th><th>ì‚­ì œ</th>
        </tr>
        {% for item in fridge_items %}
        <tr>
            <td>{{ item.ingredient.ingredient_name }}</td>
            <td>{{ item.f_quantity }}</td>
            <td>{{ item.exdate }}</td>
            <td><a href="{% url 'delete_ingredient' item.fridge_id %}" class="btn del-btn">ì‚­ì œ</a></td>
        </tr>
        {% endfor %}
    </table>

    <form method="post" action="{% url 'add_ingredient' %}">
        {% csrf_token %}
        <label>ì¬ë£Œ ì´ë¦„: <input type="text" name="ingredient" required></label>
        <label>ìˆ˜ëŸ‰: <input type="number" name="quantity" step="0.1" required></label>
        <label>ìœ í†µê¸°í•œ: <input type="date" name="exdate" required></label>
        <button type="submit" class="btn add-btn">ì¶”ê°€</button>
    </form>

    <hr>
    <h2>â¤ï¸ ì¢‹ì•„ìš”í•œ ë ˆì‹œí”¼</h2>
    <table>
        <tr>
            <th>ë ˆì‹œí”¼ ì´ë¦„</th><th>ì¹´í…Œê³ ë¦¬</th><th>ì¢‹ì•„ìš” ì·¨ì†Œ</th>
        </tr>
        {% for recipe in liked_recipes %}
        <tr>
            <td>{{ recipe.recipe_name }}</td>
            <td>{{ recipe.recipe_category }}</td>
            <td><a href="{% url 'toggle_like' recipe.recipe_id %}" class="btn like-btn">ì¢‹ì•„ìš” ì·¨ì†Œ</a></td>
        </tr>
        {% empty %}
        <tr><td colspan="3">ì¢‹ì•„ìš”í•œ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
        {% endfor %}
    </table>
    <hr>
<h2>ğŸ§  ì´ë¯¸ì§€ë¡œ ìë™ ì¸ì‹ (LLM)</h2>

<form id="llmForm" method="post" enctype="multipart/form-data" action="{% url 'classify_query' %}">
    {% csrf_token %}
    <input type="file" name="image" id="llmImage" accept="image/*" required>
    <button type="submit" class="btn add-btn">ì´ë¯¸ì§€ ë¶„ì„</button>
</form>

<p id="llmStatus" style="margin-top:10px;"></p>

<details style="margin-top:10px;">
  <summary><b>LLM ë¶„ì„ ê²°ê³¼(JSON)</b></summary>
  <pre id="llmResult" style="background:#f9f9f9; padding:12px; border:1px solid #ddd; border-radius:6px;"></pre>
</details>

<script>
(function() {
  const form = document.getElementById('llmForm');
  const statusEl = document.getElementById('llmStatus');
  const resultEl = document.getElementById('llmResult');

  function getCSRFToken() {
    const name = 'csrftoken';
    const value = document.cookie.split('; ').find(row => row.startsWith(name + '=')); 
    return value ? decodeURIComponent(value.split('=')[1]) : '';
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    statusEl.textContent = 'ë¶„ì„ ì¤‘...';
    resultEl.textContent = '';

    const formData = new FormData(form);
    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        body: formData
      });
      if (!resp.ok) {
        const t = await resp.text();
        statusEl.textContent = 'ì˜¤ë¥˜: ' + t;
        return;
      }
      // ì„œë²„ì—ì„œ food_listë¥¼ ë¬¸ìì—´(JSON)ë¡œ ë„˜ê¸°ë¯€ë¡œ ë¬¸ìì—´â†’ê°ì²´ ë³€í™˜ ì‹œë„
      const data = await resp.json();
      // dataê°€ ë¬¸ìì—´ì¼ ê²½ìš° ì¬íŒŒì‹±
      let parsed = data;
      if (typeof data === 'string') {
        try { parsed = JSON.parse(data); } catch (_) {}
      }
      statusEl.textContent = 'ì™„ë£Œ!';
      resultEl.textContent = JSON.stringify(parsed, null, 2);
    } catch (err) {
      statusEl.textContent = 'ìš”ì²­ ì‹¤íŒ¨: ' + err;
    }
  });
})();
</script>

</body>
</html>
